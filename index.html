<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>D3: Setting path fills dynamically to generate a choropleth</title>
		<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://d3js.org/d3-color.v1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.js"></script>
        <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
        <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
		<style type="text/css">
            body{
                background-color: #0c210e;
            }		
            
            button {

                border: none;
                color: white;
                padding: 15px 32px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 16px;
                font-weight: bold;
                margin: 4px 2px;
                cursor: pointer;
                top: 191px;
                left: 420px;
                background-color: #28682d;

            }
            
            h1{
                color: white;
            }

            .label{
                fill: white;
            }
            
            .legendTitle{
                fill: white;
            }
            
            .tooltip{
                color: white;
                transform: translate(900px,120px);
                position: absolute;
            }
            
		</style>
	</head>
	<body>
        
        <h1>United States Agricultural Producitivity, 2016</h1>
        
        <div class = "button-container">    
            <button class="button toggleData">Toggle Data</button>    
        </div>   
        <div class = "tooltip">
        
            <h1 class = "state-title"></h1>
            <h3 class = "tooltip-values population"></h3>
            <h3 class = "tooltip-values productivity"></h3>
        </div>
        
		<script type="text/javascript">

			//Width and height
			var w = 800;
			var h = 400;
            
            var formatComma = d3.format(",");
            
			//Define map projection
			var projection = d3.geoAlbersUsa()
								   .translate([w/2, h/2])
								   .scale([800]);

			//Define path generator
			var path = d3.geoPath()
							 .projection(projection);
							 
			//Define quantize scale to sort data values into buckets of color
			
            var colorPop = d3.scaleQuantile()
                .domain([1000000, 2500000, 7500000, 12500000, 35000000])
				.range(["#fcbba1","#fc9272","#fb6a4a","#de2d26","#a50f15"]);
			
            //var colorPop = d3.scaleSequential(d3.interpolateReds)
			
            //console.log(colorPop(4863300))
            //var colorS = d3.scaleSequential(d3.interpolateOranges)
            
            var colorAg = d3.scaleQuantize()
				.range(["#ccece6", "#66c2a4", "#41ae76", "#238b45", "#005824"]);
            //Colors derived from ColorBrewer, by Cynthia Brewer, and included in
            //https://github.com/d3/d3-scale-chromatic

            var popLegend = d3.scaleLinear()
                  .range(["#fcbba1","#a50f15"]);
            
             var agLegend = d3.scaleLinear()
                  .range(["#ccece6","#005824"]);

            var svgLegend = d3.select("body")
						      .append("svg")
						      .attr("width", w)
						      .attr("height", 80)
                              .attr("transform", "translate(120,-20)");;

            svgLegend.append("g")
              .attr("class", "legendPop")
              .attr("transform", "translate(320,20)");

            var legendPop = d3.legendColor()
              .shapeWidth(30).shapePadding(0)
              .orient('horizontal')
              .title('Population')
              .scale(popLegend);

            svgLegend.select(".legendPop")
              .call(legendPop);
            
            svgLegend.append("g")
              .attr("class", "legendAg")
              .attr("transform", "translate(120,20)");

            var legendAg = d3.legendColor()
              .shapeWidth(30).shapePadding(0)
              .orient('horizontal')
              .title('Productivty')    
              .scale(agLegend);

            svgLegend.select(".legendAg")
              .call(legendAg);
            
            
			//Create SVG element
			var svg = d3.select("body")
						.append("svg")
						.attr("width", w)
						.attr("height", h);
            
                
            //Load in agriculture and population data
            d3.csv("data.csv", function(data) {

                //Set input domain for color scale
                colorAg.domain([
                    d3.min(data, function(d) { return d.productivity; }), 
                    d3.max(data, function(d) { return d.productivity; })
                ]);
                
                agLegend.domain([
                    d3.min(data, function(d) { return d.productivity; }), 
                    d3.max(data, function(d) { return d.productivity; })
                ]);

               /* colorPop.domain([
                    d3.min(data, function(d) { return d.population; }), 
                    d3.max(data, function(d) { return d.population; })
                ]);*/

                //Load in GeoJSON data
                d3.json("us-states.json", function(json) {

                    //Merge the ag. data and GeoJSON
                    //Loop through once for each data value
                    for (var i = 0; i < data.length; i++) {

                        //Grab state name
                        var dataState = data[i].state;

                        //Grab data value, and convert from string to float
                        var productivity = parseFloat(data[i].productivity);
                        var population = parseFloat(data[i].population);

                        //Find the corresponding state inside the GeoJSON
                        for (var j = 0; j < json.features.length; j++) {

                            var jsonState = json.features[j].properties.name;

                            if (dataState == jsonState) {

                                //Copy the data value into the JSON
                                json.features[j].properties.productivity = productivity;
                                json.features[j].properties.population = population;

                                //Stop looking through the JSON
                                break;

                            }
                        }		
                    }
                    
                    console.log(json)
                    
                    //Bind data and create one path per GeoJSON feature
                    //Default map(the view on page load) will be productivity data
                    svg.selectAll("path")
                       .data(json.features)
                       .enter()
                       .append("path")
                       .attr("d", path).attr("stroke","#fff")
                       .style("fill", function(d) {
                            //Get data value
                            var value = d.properties.productivity;

                            if (value) {
                                //If value exists…
                                return colorAg(value);
                            } else {
                                //If value is undefined…
                                return "#ccc";
                            }
                       })
                       .on("mouseover",function(d){
                            var state = d.properties.name;
                            var productivity = d.properties.productivity;
                            var population = d.properties.population;
                            //console.log(d3.select(this))
                            /*d3.select(this)
                                .style("fill", "yellow");
                        */
                            d3.select(".state-title").text(state);
                            if (population){
                                d3.select(".population").text("Population | " + formatComma(population));
                            }
                            if (productivity){
                                d3.select(".productivity").text("Agricultural Productivity | " + productivity);
                            }
                        })
                        .on("mouseout", function(d){
                        
                            /*d3.select(this)
                                .style("fill", function(d) {
                            //Get data value
                                    var value = d.properties.productivity;

                                    if (value) {
                                        //If value exists…
                                        return colorAg(value);
                                    } else {
                                        //If value is undefined…
                                        return "#ccc";
                                    }
                                })
                        */
                            var state = d.properties.name;
                            var productivity = d.properties.productivity;
                            var population = d.properties.population;
                            
                            d3.select(".state-title").text("");
                            d3.select(".population").text("");
                            d3.select(".productivity").text("");
                        });
                });

            });

            // Defining Button Interactivity
            var togData = false;
             
            d3.select(".toggleData")
                .on("click", function(){
                    // Determine if current line is visible
                    togData=!togData;
                    //console.log(togData);

                    if (togData == true){
                        svg.selectAll("path")
                            .transition().duration(800)
                            .style("fill", function(d) {
                                var value = d.properties.population;

                                if (value) {
                                    //If value exists…
                                    /*console.log(colorPop(value))
                                    console.log((value))*/
                                    return colorPop(value);
                                } else {
                                    //If value is undefined…
                                    return "#ccc";
                                } 
                         });
                    
                        d3.select("body")
                            .transition().duration(800)
                            .style("background-color","#381616");
                        
                        d3.select(".toggleData")
                            .transition().duration(800)
                            .style("background-color","#823232");
                        
                        d3.select("h1")
                            .transition().duration(800)
                            .text("United States Population, 2016");
                        
                    }
                
                    if (togData == false){
                        svg.selectAll("path")
                            .transition().duration(800)
                            .style("fill", function(d) {
                                var value = d.properties.productivity;

                                if (value) {
                                    //If value exists…
                                    
                                    
                                    return colorAg(value);
                                } else {
                                    //If value is undefined…
                                    return "#ccc";
                                } 
                         });
                    
                        d3.select("body")
                            .transition().duration(800)
                            .style("background-color","#0c210e");
                        
                        d3.select(".toggleData")
                            .transition().duration(800)
                            .style("background-color","#28682d");
                        
                        d3.select("h1")
                            .transition().duration(800)
                            .text("United States Agricultural Producitivity, 2016");
                        
                    }

                 });
                /*.on("mouseover",function(d){
                            var state = d.properties.name;
                            var productivity = d.properties.productivity;
                            var population = d.properties.population;
                            //console.log(d3.select(this))
                            d3.select(this)
                                .style("fill", "yellow");
                        
                            d3.select(".state-title").text(state);
                            if (population){
                                d3.select(".population").text("Population: " + formatComma(population));
                            }
                            if (productivity){
                                d3.select(".productivity").text("Agricultural Productivity: " + productivity);
                            }
                        })*/
                /*.on("mouseout", function(d){
                            
                            var state = d.properties.name;
                            var productivity = d.properties.productivity;
                            var population = d.properties.population;
                            
                            d3.select(".state-title").text("");
                            d3.select(".population").text("");
                            d3.select(".productivity").text("");
                        });;*/

        </script>
	</body>
</html>
